---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Beaucharme Cosmétique - De la graine au flacon" } = Astro.props;
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | Beaucharme Cosmétique</title>
  </head>
  <body class="bg-grain bg-beaucharme-beige">
    <slot />

    <script is:inline>
      // Scroll reveal animation
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
          }
        });
      }, observerOptions);

      document.querySelectorAll('.animate-on-scroll').forEach((el) => {
        observer.observe(el);
      });

      // Cart functionality
      class Cart {
        constructor() {
          this.items = this.loadCart();
          this.updateCartUI();
        }

        loadCart() {
          const saved = localStorage.getItem('beaucharme-cart');
          return saved ? JSON.parse(saved) : [];
        }

        saveCart() {
          localStorage.setItem('beaucharme-cart', JSON.stringify(this.items));
          this.updateCartUI();
          this.dispatchCartUpdate();
        }

        addItem(product) {
          const existing = this.items.find((item) => item.id === product.id);
          if (existing) {
            existing.quantity += 1;
          } else {
            this.items.push({ ...product, quantity: 1 });
          }
          this.saveCart();
        }

        removeItem(productId) {
          this.items = this.items.filter((item) => item.id !== productId);
          this.saveCart();
        }

        updateQuantity(productId, quantity) {
          const item = this.items.find((item) => item.id === productId);
          if (item) {
            if (quantity <= 0) {
              this.removeItem(productId);
            } else {
              item.quantity = quantity;
              this.saveCart();
            }
          }
        }

        getTotal() {
          return this.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        getItemCount() {
          return this.items.reduce((sum, item) => sum + item.quantity, 0);
        }

        updateCartUI() {
          const countElements = document.querySelectorAll('[data-cart-count]');
          const count = this.getItemCount();
          countElements.forEach((el) => {
            el.textContent = count.toString();
            el.style.display = count > 0 ? 'flex' : 'none';
          });
        }

        dispatchCartUpdate() {
          window.dispatchEvent(new CustomEvent('cart-updated', { detail: { items: this.items } }));
        }

        clear() {
          this.items = [];
          this.saveCart();
        }
      }

      // Initialize cart globally
      window.beaucharmeCart = new Cart();

      // Handle cart button clicks
      document.addEventListener('click', (e) => {
        const target = e.target;
        const addToCartBtn = target.closest('[data-add-to-cart]');
        if (addToCartBtn) {
          const productData = addToCartBtn.dataset.product;
          if (productData) {
            const product = JSON.parse(productData);
            window.beaucharmeCart.addItem(product);

            // Show feedback
            addToCartBtn.textContent = 'Ajouté !';
            addToCartBtn.classList.add('bg-beaucharme-sage');
            setTimeout(() => {
              addToCartBtn.textContent = 'Ajouter au panier';
              addToCartBtn.classList.remove('bg-beaucharme-sage');
            }, 1500);
          }
        }

        // Toggle cart sidebar
        const cartToggle = target.closest('[data-cart-toggle]');
        if (cartToggle) {
          const sidebar = document.getElementById('cart-sidebar');
          const overlay = document.getElementById('cart-overlay');
          if (sidebar) {
            const isOpening = sidebar.classList.contains('translate-x-full');
            sidebar.classList.toggle('translate-x-full');
            document.body.classList.toggle('overflow-hidden');
            if (overlay) {
              overlay.classList.toggle('hidden', !isOpening);
            }
          }
        }

        // Close cart
        const cartClose = target.closest('[data-cart-close]');
        if (cartClose) {
          const sidebar = document.getElementById('cart-sidebar');
          const overlay = document.getElementById('cart-overlay');
          if (sidebar) {
            sidebar.classList.add('translate-x-full');
            document.body.classList.remove('overflow-hidden');
            if (overlay) {
              overlay.classList.add('hidden');
            }
          }
        }

        // Mobile menu toggle
        const menuToggle = target.closest('[data-menu-toggle]');
        if (menuToggle) {
          const mobileMenu = document.getElementById('mobile-menu');
          if (mobileMenu) {
            mobileMenu.classList.toggle('hidden');
            document.body.classList.toggle('overflow-hidden');
          }
        }
      });
    </script>
  </body>
</html>
