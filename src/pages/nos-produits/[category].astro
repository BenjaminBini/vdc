---
import type { ImageMetadata } from 'astro';
import Layout from '@layouts/Layout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import PageContainer from '@components/PageContainer.astro';
import HeroSection from '@components/HeroSection.astro';
import Section from '@components/Section.astro';
import CheckList from '@components/CheckList.astro';
import CartSidebar from '@components/CartSidebar.tsx';
import ProductCardReact from '@components/ProductCardReact.tsx';
import productsData from '@data/products.json';

// Import hero images for categories
import huilesVegetales from '@images/huiles-vegetales.jpg';
import huilesSoin from '@images/huiles-soin.jpg';
import savonsHero from '@images/savons-hero.jpg';
import cremesMains from '@images/cremes-mains.jpg';
import distillation from '@images/distillation.jpg';
import coffretsHero from '@images/coffrets-hero.jpg';


// Hero images mapping
const heroImages: Record<string, ImageMetadata> = {
  'huiles-vegetales': huilesVegetales,
  'huiles-soin': huilesSoin,
  'savons': savonsHero,
  'cremes-mains': cremesMains,
  'eaux-florales': distillation,
  'coffrets': coffretsHero,
};

export function getStaticPaths() {
  // Story content as arrays of paragraphs (safe - no HTML injection risk)
  const categoriesInfo = {
    'huiles-vegetales': {
      name: 'Huiles végétales',
      tagline: 'De la graine à la bouteille',
      description: 'Nos huiles sont pressées à froid dans notre atelier, à partir de graines cultivées sur notre ferme près de Vézelay. Chanvre, tournesol, cameline, carthame, bourrache... Chaque plante est choisie pour ses vertus exceptionnelles.',
      storyParagraphs: [
        'Tout commence par la graine. Nous semons nous-mêmes nos cultures au printemps, sur les terres argilo-calcaires de notre ferme bourguignonne. Le terroir, le climat et notre patience font le reste.',
        'À maturité, nous récoltons les graines puis les pressons dans les jours qui suivent pour préserver tous leurs bienfaits. Notre presse à vis sans fin travaille à basse température — c\'est ce qu\'on appelle la première pression à froid.',
        'Le résultat : des huiles d\'une pureté exceptionnelle, riches en acides gras essentiels, vitamines et antioxydants. Aucun solvant, aucun raffinage. Juste la nature à l\'état pur.',
      ],
      benefits: ['Riches en oméga-3 et oméga-6', 'Non raffinées, première pression à froid', '100% cultivées sur notre ferme', 'Sans pesticides ni engrais chimiques'],
      color: 'beaucharme-sage',
    },
    'huiles-soin': {
      name: 'Huiles de soin',
      tagline: 'Formulations signature',
      description: 'Nos huiles de soin sont des assemblages subtils de nos meilleures huiles végétales, enrichies de macérats de plantes et de vitamine E naturelle.',
      storyParagraphs: [
        'Créer une huile de soin, c\'est comme composer un parfum ou une recette de cuisine : il faut trouver l\'équilibre parfait entre les différents ingrédients.',
        'Nous passons des mois à tester différentes combinaisons, à ajuster les proportions, à évaluer la texture et l\'absorption. Chaque formule est le fruit de cette recherche patiente.',
        'Nos huiles de soin conviennent à tous les types de peau et peuvent s\'utiliser sur le visage comme sur le corps. Quelques gouttes suffisent pour nourrir, protéger et sublimer votre peau.',
      ],
      benefits: ['Formules exclusives développées sur notre ferme', 'Synergie d\'huiles aux vertus complémentaires', 'Enrichies en vitamine E naturelle', 'Conviennent à tous les types de peau'],
      color: 'beaucharme-terracotta',
    },
    'savons': {
      name: 'Savons surgras',
      tagline: 'Saponification à froid',
      description: 'Nos savons sont fabriqués selon la méthode ancestrale de saponification à froid, qui préserve la glycérine naturelle et les propriétés de nos huiles.',
      storyParagraphs: [
        'La saponification à froid est un procédé lent et délicat, mais c\'est le seul qui permet de conserver toutes les propriétés de nos huiles précieuses.',
        'Nous mélangeons nos huiles avec une solution de soude, puis nous coulons la pâte dans des moules en bois. Le savon doit ensuite sécher pendant 4 à 6 semaines — c\'est la cure.',
        'Le résultat est un savon surgras, naturellement riche en glycérine, qui nettoie en douceur sans jamais assécher la peau. Nos savons sont enrichis à la cire d\'abeille de nos propres ruches.',
      ],
      benefits: ['Saponification à froid artisanale', 'Surgras pour ne pas assécher la peau', 'Enrichis à la cire d\'abeille locale', 'Cure de 4 à 6 semaines'],
      color: 'beaucharme-gold',
    },
    'cremes-mains': {
      name: 'Crèmes mains',
      tagline: 'Sans eau, 100% actifs',
      description: 'Une innovation dont nous sommes fiers : des crèmes mains sans eau ajoutée, conditionnées en tubes végétaux.',
      storyParagraphs: [
        'Pourquoi ajouter de l\'eau dans une crème ? L\'eau n\'hydrate pas, elle dilue les actifs et nécessite des conservateurs. Nous avons voulu faire différemment.',
        'Nos crèmes mains sont formulées uniquement avec du beurre de karité, de la cire d\'abeille et nos huiles précieuses. Une formule concentrée en actifs qui nourrit intensément.',
        'Et parce que nous pensons à tout, nos tubes sont en plastique végétal biodégradable. Nos mains d\'agriculteurs, mises à rude épreuve, adorent cette crème. Les vôtres aussi.',
      ],
      benefits: ['Formule sans eau, 100% actifs', 'Tubes en plastique végétal biodégradable', 'Pénétration rapide, fini non gras', 'Testée par nos mains d\'agriculteurs'],
      color: 'beaucharme-earth',
    },
    'eaux-florales': {
      name: 'Eaux florales',
      tagline: 'Distillation artisanale',
      description: 'Nos hydrolats sont obtenus par distillation à la vapeur d\'eau dans notre alambic en cuivre. Des fleurs de notre jardin pour des soins frais et aromatiques.',
      storyParagraphs: [
        'Au petit matin, quand la rosée perle encore sur les pétales, nous récoltons nos fleurs à la main. Lavandin, menthe poivrée, camomille romaine, sauge sclarée... chacune a son moment idéal de récolte.',
        'Les fleurs sont immédiatement placées dans notre alambic en cuivre. La vapeur d\'eau traverse doucement la matière végétale, emportant avec elle les précieuses molécules aromatiques.',
        'En refroidissant, cette vapeur se condense en deux phases : l\'huile essentielle qui flotte, et l\'hydrolat, chargé des principes actifs hydrosolubles de la plante. C\'est cet hydrolat que nous embouteillons pour vous.',
      ],
      benefits: ['Distillation artisanale à la vapeur d\'eau', 'Fleurs récoltées dans notre jardin', 'Alambic en cuivre traditionnel', 'Sans conservateur ajouté'],
      color: 'beaucharme-sage',
    },
    'coffrets': {
      name: 'Coffrets',
      tagline: 'L\'art d\'offrir',
      description: 'Nos coffrets réunissent une sélection de nos meilleurs produits pour découvrir notre univers ou faire un cadeau qui a du sens.',
      storyParagraphs: [
        'Offrir un coffret Beaucharme, c\'est offrir un morceau de notre ferme, un peu de notre passion, beaucoup de nature.',
        'Chaque coffret est préparé avec soin dans notre atelier. Nous choisissons les produits pour qu\'ils se complètent harmonieusement et offrent une expérience complète.',
        'Emballages en carton recyclé, rubans en coton bio, papier de soie sans acide... nous soignons chaque détail pour que le cadeau soit aussi beau à offrir qu\'à recevoir.',
      ],
      benefits: ['Sélections harmonieuses de produits', 'Emballages en matériaux recyclés', 'Parfaits pour offrir ou se faire plaisir', 'Différentes gammes de prix'],
      color: 'beaucharme-terracotta',
    },
  };

  return Object.keys(categoriesInfo).map((categoryId) => ({
    params: { category: categoryId },
    props: { categoryInfo: categoriesInfo[categoryId], categoryId },
  }));
}

const { categoryInfo, categoryId } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;

// Filter and transform products to add baseUrl to image paths
const products = productsData.products
  .filter(p => p.category === categoryId)
  .map(p => ({
    ...p,
    image: p.image.startsWith('/') && !p.image.startsWith('//') ? `${baseUrl}${p.image}` : p.image
  }));
---

<Layout title={categoryInfo.name} description={categoryInfo.description}>
  <PageContainer>
    <Header />

    <main class="min-h-screen flex flex-col gap-8">
      <HeroSection
        image={heroImages[categoryId]}
        alt={categoryInfo.name}
        tagline={categoryInfo.tagline}
        title={categoryInfo.name}
        height="small"
        overlay="gradient"
        align="bottom"
      />

      <!-- Introduction -->
      <Section bg="cream" padding="small" class="px-8 md:px-12">
        <p class="text-lg md:text-xl text-beaucharme-earth leading-relaxed">
          {categoryInfo.description}
        </p>
      </Section>

      <!-- Story Section -->
      <Section bg="transparent" padding="none" card={false}>
        <div class="grid md:grid-cols-2 rounded-2xl overflow-hidden shadow-md">
          <div class="bg-white p-8 md:p-12">
            <h2 class="font-serif text-3xl md:text-4xl font-semibold text-beaucharme-dark mb-8">
              Notre savoir-faire
            </h2>
            <div class="prose prose-lg text-beaucharme-earth space-y-4">
              {categoryInfo.storyParagraphs.map((paragraph: string) => (
                <p>{paragraph}</p>
              ))}
            </div>
          </div>
          <div class={`bg-${categoryInfo.color} p-8 md:p-12 flex flex-col justify-center`}>
            <h3 class="text-2xl tracking-[0.1em] uppercase font-bold text-white mb-6">Nos engagements</h3>
            <CheckList items={categoryInfo.benefits} variant="light" iconColor="white" />
          </div>
        </div>
      </Section>

      <!-- Products -->
      <section class="py-16 md:py-24">
        <div class="container-custom">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-12">
            <div>
              <h2 class="font-serif text-3xl md:text-4xl font-semibold text-beaucharme-dark">
                Nos {categoryInfo.name.toLowerCase()}
              </h2>
              <p class="text-beaucharme-earth mt-2">{products.length} produits disponibles</p>
            </div>
            <a
              href={`${baseUrl}/boutique`}
              class="inline-flex items-center text-beaucharme-terracotta font-medium hover:gap-3 transition-all"
            >
              Voir toute la boutique
              <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </a>
          </div>

          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
            {products.map((product) => (
              <ProductCardReact
                client:load
                product={product}
                baseUrl={baseUrl}
              />
            ))}
          </div>
        </div>
      </section>

      <!-- Back & CTA -->
      <div class="flex flex-col sm:flex-row items-center justify-between gap-6 py-4">
        <a
          href={`${baseUrl}/nos-produits`}
          class="inline-flex items-center text-beaucharme-earth hover:text-beaucharme-dark transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
          </svg>
          Retour aux catégories
        </a>
        <a
          href={`${baseUrl}/boutique`}
          class="inline-flex items-center bg-beaucharme-terracotta text-white px-6 py-3 rounded-full font-medium hover:bg-beaucharme-terracotta-dark transition-colors"
        >
          Accéder à la boutique
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
          </svg>
        </a>
      </div>
    </main>

    <Footer />
    <CartSidebar client:load />
  </PageContainer>
</Layout>

<style>
  .prose p {
    color: var(--color-beaucharme-earth);
    line-height: 1.625;
  }
</style>
